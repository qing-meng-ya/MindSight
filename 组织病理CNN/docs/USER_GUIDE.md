# ç»„ç»‡ç—…ç†CNNè¯†åˆ«ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
4. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
5. [è®­ç»ƒæ¨¡å‹](#è®­ç»ƒæ¨¡å‹)
6. [æ¨¡å‹è¯„ä¼°](#æ¨¡å‹è¯„ä¼°)
7. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ç³»ç»Ÿæ¦‚è¿°

### åŠŸèƒ½ç‰¹æ€§
- ğŸ”¬ **15ç§ç—…ç†ç±»å‹è¯†åˆ«**ï¼šè¦†ç›–è‚ºã€å¿ƒã€è„‘ã€è‚ã€è„¾ã€è‚¾ã€èƒ°è…ºç­‰å¤šä¸ªå™¨å®˜
- ğŸ¤– **æ·±åº¦å­¦ä¹ é©±åŠ¨**ï¼šåŸºäºPyTorchå’Œé¢„è®­ç»ƒæ¨¡å‹çš„é«˜ç²¾åº¦è¯†åˆ«
- ğŸ“Š **è¾…åŠ©è¯Šæ–­æŠ¥å‘Š**ï¼šè‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„è¯Šæ–­å»ºè®®å’Œç½®ä¿¡åº¦åˆ†æ
- ğŸš€ **é«˜æ€§èƒ½API**ï¼šFastAPIæ„å»ºçš„RESTfulæ¥å£ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†
- ğŸ“ˆ **å®Œæ•´è¯„ä¼°ä½“ç³»**ï¼šå…¨é¢çš„æ¨¡å‹æ€§èƒ½åˆ†æå’Œå¯è§†åŒ–å·¥å…·

### æ”¯æŒçš„ç—…ç†ç±»å‹

#### è‚ºéƒ¨ç—…å˜
- è‚ºå‡ºè¡€
- è‚ºæ°´è‚¿
- è‚ºè¡€æ “
- è‚ºç‚

#### å¿ƒè¡€ç®¡ç—…å˜
- å† å¿ƒç—…
- å¿ƒè‚Œçº¤ç»´æ–­è£‚
- å¿ƒè‚Œç‚

#### è„‘éƒ¨ç—…å˜
- è„‘å‡ºè¡€
- è„‘æ°´è‚¿
- è„‘è¡€ç®¡ç•¸å½¢
- è„‘è››ç½‘è†œä¸‹è…”æ·¤è¡€

#### å…¶ä»–å™¨å®˜ç—…å˜
- è‚è„‚è‚ªå˜æ€§
- è„¾å°åŠ¨è„‰ç»ç’ƒæ ·æ”¹å˜
- è‚¾å°çƒçº¤ç»´åŒ–
- èƒ°è…ºç‚

## ç¯å¢ƒé…ç½®

### ç³»ç»Ÿè¦æ±‚
- Python 3.8+
- CUDA 11.0+ (GPUåŠ é€Ÿï¼Œå¯é€‰)
- å†…å­˜: 8GB+ (æ¨è16GB+)
- å­˜å‚¨: 10GB+ å¯ç”¨ç©ºé—´

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd ç»„ç»‡ç—…ç†CNN
```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
python -m venv pathology_env
source pathology_env/bin/activate  # Linux/Mac
# æˆ–
pathology_env\Scripts\activate  # Windows
```

3. **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

4. **éªŒè¯å®‰è£…**
```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}')"
```

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨APIæœåŠ¡

```bash
python main.py
```

æœåŠ¡å°†åœ¨ http://localhost:8000 å¯åŠ¨

### 2. è®¿é—®APIæ–‡æ¡£

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 3. æµ‹è¯•API

ä½¿ç”¨curlæµ‹è¯•ï¼š
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# é¢„æµ‹å›¾åƒ
curl -X POST "http://localhost:8000/predict" \
  -H "accept: application/json" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@your_image.jpg"
```

### 4. Pythonå®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests

# é¢„æµ‹å•å¼ å›¾åƒ
with open('test_image.jpg', 'rb') as f:
    files = {'file': f}
    response = requests.post('http://localhost:8000/predict', files=files)
    result = response.json()
    print(f"é¢„æµ‹ç»“æœ: {result['prediction']['class']}")
    print(f"ç½®ä¿¡åº¦: {result['prediction']['confidence']:.3f}")
```

## APIæ¥å£æ–‡æ¡£

### åŸºç¡€ä¿¡æ¯
- **Base URL**: `http://localhost:8000`
- **Content-Type**: `multipart/form-data` (å›¾åƒä¸Šä¼ )
- **å“åº”æ ¼å¼**: `application/json`

### æ ¸å¿ƒæ¥å£

#### 1. å•å¼ å›¾åƒé¢„æµ‹
```http
POST /predict
```

**å‚æ•°:**
- `file` (required): å›¾åƒæ–‡ä»¶

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "prediction": {
    "class": "è‚ºç‚",
    "confidence": 0.892,
    "description": "è‚ºéƒ¨ç‚ç—‡ååº”ï¼Œç‚æ€§ç»†èƒæµ¸æ¶¦",
    "threshold_met": true
  },
  "top_predictions": [
    {
      "class": "è‚ºç‚",
      "probability": 0.892,
      "description": "è‚ºéƒ¨ç‚ç—‡ååº”ï¼Œç‚æ€§ç»†èƒæµ¸æ¶¦",
      "rank": 1
    }
  ],
  "metadata": {
    "model_info": {
      "type": "resnet50",
      "epoch": 85,
      "device": "cuda"
    }
  }
}
```

#### 2. æ‰¹é‡é¢„æµ‹
```http
POST /predict_batch
```

**å‚æ•°:**
- `files[]` (required): å›¾åƒæ–‡ä»¶åˆ—è¡¨ (æœ€å¤š20å¼ )

#### 3. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
```http
POST /diagnose
```

**å‚æ•°:**
- `file` (required): å›¾åƒæ–‡ä»¶
- `patient_info` (optional): JSONæ ¼å¼çš„æ‚£è€…ä¿¡æ¯

**æ‚£è€…ä¿¡æ¯ç¤ºä¾‹:**
```json
{
  "name": "å¼ ä¸‰",
  "age": "45",
  "gender": "ç”·",
  "clinical_notes": "å’³å—½å‘çƒ­3å¤©"
}
```

#### 4. è·å–æ”¯æŒçš„ç—…ç†ç±»å‹
```http
GET /classes
```

#### 5. è·å–æ¨¡å‹ä¿¡æ¯
```http
GET /model_info
```

#### 6. å¥åº·æ£€æŸ¥
```http
GET /health
```

### é”™è¯¯å¤„ç†

APIä½¿ç”¨æ ‡å‡†HTTPçŠ¶æ€ç ï¼š
- `200`: æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

é”™è¯¯å“åº”æ ¼å¼ï¼š
```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°",
  "timestamp": "2024-01-01T12:00:00"
}
```

## è®­ç»ƒæ¨¡å‹

### æ•°æ®å‡†å¤‡

1. **æ•°æ®ç›®å½•ç»“æ„**
```
data/
â”œâ”€â”€ raw/
â”‚   â”œâ”€â”€ è‚ºç‚/
â”‚   â”‚   â”œâ”€â”€ image1.jpg
â”‚   â”‚   â””â”€â”€ image2.jpg
â”‚   â”œâ”€â”€ è‚ºå‡ºè¡€/
â”‚   â””â”€â”€ ...
â””â”€â”€ models/
```

2. **æ•°æ®è¦æ±‚**
- å›¾åƒæ ¼å¼: JPG, PNG, TIFF
- æœ€å°å°ºå¯¸: 224x224
- æ¯ç±»è‡³å°‘100å¼ æ ·æœ¬

### å¼€å§‹è®­ç»ƒ

```bash
python scripts/train.py \
  --data_dir data/raw \
  --model_type resnet50 \
  --epochs 100 \
  --batch_size 32 \
  --lr 0.001
```

### è®­ç»ƒå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--data_dir` | è®­ç»ƒæ•°æ®ç›®å½• | å¿…éœ€ |
| `--model_type` | æ¨¡å‹ç±»å‹ | resnet50 |
| `--epochs` | è®­ç»ƒè½®æ¬¡ | 100 |
| `--batch_size` | æ‰¹æ¬¡å¤§å° | 32 |
| `--lr` | å­¦ä¹ ç‡ | 0.001 |
| `--loss_type` | æŸå¤±å‡½æ•° | focal |
| `--use_class_weights` | ä½¿ç”¨ç±»åˆ«æƒé‡ | False |

### ç›‘æ§è®­ç»ƒ

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ï¼š
- ä¿å­˜æœ€ä½³æ¨¡å‹
- ç”Ÿæˆè®­ç»ƒæ›²çº¿å›¾
- åº”ç”¨æ—©åœç­–ç•¥
- è®¡ç®—å„ç±»æŒ‡æ ‡

## æ¨¡å‹è¯„ä¼°

### è¯„ä¼°å·²è®­ç»ƒæ¨¡å‹

```bash
python scripts/evaluate.py \
  --data_dir data/raw \
  --model_path data/models/best_model.pth \
  --output_dir evaluation_results
```

### è¯„ä¼°æŒ‡æ ‡

- **åŸºç¡€æŒ‡æ ‡**: å‡†ç¡®ç‡ã€ç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°
- **è¯¦ç»†åˆ†æ**: æ¯ç±»æ€§èƒ½ã€æ··æ·†çŸ©é˜µ
- **æ¨¡å‹å¤æ‚åº¦**: å‚æ•°æ•°é‡ã€æ¨ç†é€Ÿåº¦ã€æ¨¡å‹å¤§å°
- **æ•°æ®å¹³è¡¡æ€§**: ç±»åˆ«åˆ†å¸ƒåˆ†æ

### å¯è§†åŒ–ç»“æœ

è¯„ä¼°ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
- æ··æ·†çŸ©é˜µçƒ­å›¾
- åˆ†ç±»æ€§èƒ½çƒ­å›¾
- è®­ç»ƒå†å²æ›²çº¿
- è¯¦ç»†çš„HTMLæŠ¥å‘Š

## éƒ¨ç½²æŒ‡å—

### Dockeréƒ¨ç½²

1. **æ„å»ºé•œåƒ**
```bash
docker build -t pathology-cnn .
```

2. **è¿è¡Œå®¹å™¨**
```bash
docker run -p 8000:8000 -v $(pwd)/data:/app/data pathology-cnn
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **ä½¿ç”¨Gunicorn**
```bash
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:8000
```

2. **ä½¿ç”¨Nginxåå‘ä»£ç†**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 50M;
}
```

### æ€§èƒ½ä¼˜åŒ–

1. **GPUåŠ é€Ÿ**: ç¡®ä¿CUDAç¯å¢ƒæ­£ç¡®é…ç½®
2. **æ‰¹é‡å¤„ç†**: ä½¿ç”¨`/predict_batch`æ¥å£å¤„ç†å¤šå¼ å›¾åƒ
3. **æ¨¡å‹é‡åŒ–**: è€ƒè™‘ä½¿ç”¨TensorRTæˆ–å…¶ä»–æ¨ç†ä¼˜åŒ–å·¥å…·
4. **ç¼“å­˜ç­–ç•¥**: å¯¹é¢‘ç¹è¯·æ±‚çš„æ¨¡å‹ç»“æœè¿›è¡Œç¼“å­˜

## å¸¸è§é—®é¢˜

### Q1: æ¨¡å‹é¢„æµ‹ç»“æœç½®ä¿¡åº¦å¾ˆä½æ€ä¹ˆåŠï¼Ÿ
A: å¯èƒ½çš„åŸå› ï¼š
- è¾“å…¥å›¾åƒè´¨é‡å·®
- å›¾åƒä¸­ä¸åŒ…å«ç›®æ ‡ç—…ç†ç‰¹å¾
- éœ€è¦é‡æ–°è®­ç»ƒæˆ–å¾®è°ƒæ¨¡å‹

**è§£å†³æ–¹æ³•:**
```python
# ä½¿ç”¨æµ‹è¯•æ—¶æ•°æ®å¢å¼º
result = predictor.predict_single(image, use_tta=True)
```

### Q2: å¦‚ä½•æ·»åŠ æ–°çš„ç—…ç†ç±»å‹ï¼Ÿ
A: éœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹ï¼š
1. æ”¶é›†æ–°ç±»å‹çš„è®­ç»ƒæ•°æ®
2. æ›´æ–°`configs/config.py`ä¸­çš„ç±»åˆ«åˆ—è¡¨
3. é‡æ–°è®­ç»ƒæ¨¡å‹
4. æ›´æ–°APIæ–‡æ¡£

### Q3: APIå“åº”å¾ˆæ…¢æ€ä¹ˆä¼˜åŒ–ï¼Ÿ
A: ä¼˜åŒ–å»ºè®®ï¼š
- ä½¿ç”¨GPUåŠ é€Ÿ
- å¢åŠ workerè¿›ç¨‹æ•°
- ä½¿ç”¨æ¨¡å‹é‡åŒ–
- å¯ç”¨æ‰¹é‡é¢„æµ‹

### Q4: å¦‚ä½•ç›‘æ§APIæ€§èƒ½ï¼Ÿ
A: å¯ä»¥é›†æˆç›‘æ§å·¥å…·ï¼š
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
python tests/test_api.py --url http://localhost:8000 --image test.jpg
```

### Q5: æ¨¡å‹è®­ç»ƒæ—¶æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: è§£å†³æ–¹æ¡ˆï¼š
- å‡å°`batch_size`
- ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯
- é€‰æ‹©æ›´å°çš„æ¨¡å‹æ¶æ„
- ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ

## æŠ€æœ¯æ”¯æŒ

- ğŸ“§ **é‚®ç®±**: support@pathology-ai.com
- ğŸ› **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/your-repo/issues)
- ğŸ“– **è¯¦ç»†æ–‡æ¡£**: [åœ¨çº¿æ–‡æ¡£](https://docs.pathology-ai.com)

---

**æ³¨æ„**: æœ¬ç³»ç»Ÿä»…ä¾›è¾…åŠ©è¯Šæ–­ä½¿ç”¨ï¼Œæœ€ç»ˆè¯Šæ–­åº”ç”±ä¸“ä¸šåŒ»å¸ˆåšå‡ºã€‚