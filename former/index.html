<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æ³•é‰´å®šåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .hidden {
            display: none !important;
        }

        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .auth-container h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .auth-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .demo-btn {
            background: #ff9800;
            margin-top: 10px;
        }

        .demo-btn:hover:not(:disabled) {
            background: #f57c00;
        }

        .demo-badge {
            background: #ff9800;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
        }

        button.secondary {
            background: #e0e0e0;
            color: #333;
        }

        button.secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .auth-container p {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-container a {
            color: #667eea;
            text-decoration: none;
        }

        .auth-container a:hover {
            text-decoration: underline;
        }

        .layout {
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 0 30px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            color: #667eea;
        }

        .nav {
            display: flex;
            gap: 5px;
        }

        .nav button {
            width: auto;
            padding: 8px 16px;
            background: transparent;
            color: #555;
            border: none;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav button:hover,
        .nav button.active {
            background: #667eea;
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .logout-btn {
            width: auto;
            padding: 8px 16px;
            background: #e0e0e0;
            color: #333;
            font-size: 14px;
        }

        .main-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard h2,
        .diagnosis-page h2,
        .history-page h2,
        .admin-page h2 {
            margin-bottom: 30px;
            color: #333;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .stat-link:hover {
            background: #667eea;
            color: white;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table .actions {
            display: flex;
            gap: 8px;
        }

        .data-table .actions button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
        }

        .dropzone {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .dropzone:hover,
        .dropzone.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .dropzone p {
            color: #666;
            margin-top: 10px;
        }

        .preview-container {
            position: relative;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 6px;
        }

        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .diagnosis-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .result-section {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .result-main h4 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .confidence {
            font-size: 18px;
            color: #28a745;
            margin-bottom: 10px;
        }

        .diagnosis-type {
            color: #666;
            margin-bottom: 20px;
        }

        .result-details {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .result-details h5 {
            margin-bottom: 10px;
            color: #555;
        }

        .result-details ul {
            list-style: none;
        }

        .result-details li {
            padding: 5px 0;
            color: #666;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .result-actions button {
            flex: 1;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .detail-content {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-row .label {
            width: 100px;
            color: #666;
            font-weight: 500;
        }

        .detail-row .value {
            flex: 1;
            word-break: break-all;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-actions button {
            flex: 1;
            min-width: 100px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .access-denied {
            text-align: center;
            color: #c33;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 18px;
            color: #666;
        }

        .recent-section {
            margin-top: 40px;
        }

        .recent-section h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .config-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
        }

        .config-panel h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .config-panel input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }

        .config-panel button {
            width: auto;
            padding: 8px 12px;
            font-size: 12px;
        }

        .config-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* ===== æ–°å¢æ ·å¼ ===== */
        .page-container { padding: 20px 0; }
        .page-header { margin-bottom: 30px; }
        .page-header h1 { font-size: 28px; color: #333; margin-bottom: 8px; }
        .page-header p { color: #666; font-size: 14px; }

        .page-with-sidebar { display: grid; grid-template-columns: 240px 1fr; gap: 30px; }
        .sidebar { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); height: fit-content; }
        .sidebar-title { font-size: 16px; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin-bottom: 8px; }
        .sidebar-menu a { display: block; padding: 10px 14px; color: #555; text-decoration: none; border-radius: 8px; transition: all 0.3s; font-size: 14px; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background: #667eea; color: white; }

        .home-hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 60px 40px; text-align: center; color: white; margin-bottom: 40px; }
        .home-hero h1 { color: white; font-size: 36px; margin-bottom: 10px; }
        .home-hero .hero-subtitle { font-size: 18px; opacity: 0.9; margin-bottom: 16px; }
        .home-hero .hero-desc { font-size: 16px; opacity: 0.8; max-width: 600px; margin: 0 auto 30px; }
        .home-hero .hero-actions { display: flex; gap: 15px; justify-content: center; }
        .home-hero button { max-width: 160px; }
        .home-hero button.secondary { background: rgba(255,255,255,0.2); border: 2px solid white; }

        .section-title { margin: 40px 0 24px; color: #333; }

        .form-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .form-card h2 { font-size: 22px; color: #333; margin-bottom: 24px; }

        .upload-zone { border: 2px dashed #ddd; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafafa; }
        .upload-zone:hover { border-color: #667eea; background: #f8f9ff; }
        .upload-zone.has-image { padding: 20px; }
        .upload-icon { font-size: 48px; color: #667eea; margin-bottom: 16px; }
        .upload-zone p { color: #666; margin-bottom: 8px; }
        .upload-zone .hint { font-size: 12px; color: #999; }
        .upload-preview { max-width: 100%; max-height: 300px; border-radius: 8px; }
        .upload-actions { display: flex; gap: 10px; justify-content: center; margin-top: 16px; }
        .upload-actions button { width: auto; padding: 8px 16px; font-size: 14px; }

        .calculator-result { background: #f8f9ff; border-radius: 12px; padding: 24px; margin-top: 24px; }
        .calculator-result h4 { color: #667eea; margin-bottom: 16px; }
        .result-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .result-item:last-child { border-bottom: none; }
        .result-item .label { color: #666; }
        .result-item .value { font-weight: bold; color: #333; }

        .search-bar { display: flex; gap: 15px; margin-bottom: 24px; }
        .search-input { flex: 1; position: relative; }
        .search-input input { width: 100%; padding: 12px 16px 12px 44px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .search-input::before { content: "ğŸ”"; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); }
        .filter-select { min-width: 150px; padding: 12px; border-radius: 8px; border: 1px solid #ddd; }

        .toxin-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .toxin-table th, .toxin-table td { padding: 16px; text-align: left; border-bottom: 1px solid #eee; }
        .toxin-table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 14px; }
        .toxin-table tr:hover td { background: #f8f9fa; }
        .danger-level { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
        .danger-level.high { background: #ffebee; color: #c62828; }
        .danger-level.medium { background: #fff3e0; color: #ef6c00; }
        .danger-level.low { background: #e8f5e9; color: #2e7d32; }

        .standard-card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .standard-card h3 { font-size: 18px; color: #333; margin-bottom: 12px; }
        .standard-card p { color: #666; line-height: 1.6; }

        .expert-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; gap: 20px; margin-bottom: 20px; }
        .expert-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; }
        .expert-info h3 { font-size: 18px; color: #333; margin-bottom: 4px; }
        .expert-info .title { color: #667eea; font-size: 14px; margin-bottom: 8px; }
        .expert-info .specialty { color: #666; font-size: 14px; margin-bottom: 12px; }
        .expert-stats { display: flex; gap: 20px; font-size: 13px; color: #999; }
        .expert-actions { display: flex; gap: 10px; margin-top: 16px; }
        .expert-actions button { width: auto; padding: 8px 20px; font-size: 14px; }

        .qa-item { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .qa-question { font-weight: 500; color: #333; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .qa-answer { color: #666; line-height: 1.6; }
        .qa-meta { display: flex; justify-content: space-between; margin-top: 12px; font-size: 12px; color: #999; }

        .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; color: white; display: flex; align-items: center; gap: 24px; margin-bottom: 30px; }
        .profile-avatar { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #667eea; }
        .profile-info h2 { font-size: 24px; margin-bottom: 4px; color: white; }
        .profile-stats { display: flex; gap: 30px; margin-left: auto; }
        .profile-stat { text-align: center; }
        .profile-stat .number { font-size: 28px; font-weight: bold; }
        .profile-stat .label { font-size: 12px; opacity: 0.8; }

        .tabs { display: flex; gap: 4px; background: #f5f7fa; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
        .tab { flex: 1; padding: 12px 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; color: #666; }
        .tab:hover { background: #e8eef5; }
        .tab.active { background: white; color: #667eea; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        @media (max-width: 1024px) { .page-with-sidebar { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .home-hero { padding: 40px 20px; } .home-hero h1 { font-size: 28px; } .expert-card { flex-direction: column; text-align: center; } .profile-header { flex-direction: column; text-align: center; } .profile-stats { margin-left: 0; justify-content: center; } }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'http://localhost:3001/api';

        // æ¨¡æ‹Ÿæ•°æ®
        const MOCK_RECORDS = [
            { id: 1, patient_name: 'å¼ ä¸‰', patient_id: 'P001', prediction_result: 'è‚ºå‡ºè¡€', confidence: 0.92, diagnosis_type: 'è‚ºéƒ¨ç—…å˜', created_at: '2024-01-15' },
            { id: 2, patient_name: 'æå››', patient_id: 'P002', prediction_result: 'å† å¿ƒç—…', confidence: 0.88, diagnosis_type: 'å¿ƒè¡€ç®¡ç—…å˜', created_at: '2024-01-14' },
            { id: 3, patient_name: 'ç‹äº”', patient_id: 'P003', prediction_result: 'è„‘å‡ºè¡€', confidence: 0.95, diagnosis_type: 'è„‘éƒ¨ç—…å˜', created_at: '2024-01-13' },
            { id: 4, patient_name: 'èµµå…­', patient_id: 'P004', prediction_result: 'è‚è„‚è‚ªå˜æ€§', confidence: 0.85, diagnosis_type: 'è‚è„ç—…å˜', created_at: '2024-01-12' },
            { id: 5, patient_name: 'é’±ä¸ƒ', patient_id: 'P005', prediction_result: 'å¿ƒè‚Œç‚', confidence: 0.91, diagnosis_type: 'å¿ƒè¡€ç®¡ç—…å˜', created_at: '2024-01-11' }
        ];

        const MOCK_PREDICTION_RESULT = {
            success: true,
            diagnosis_id: Math.floor(Math.random() * 1000) + 1000,
            prediction: {
                result: 'è‚ºå‡ºè¡€',
                confidence: 0.92,
                diagnosis_type: 'è‚ºéƒ¨ç—…å˜',
                all_predictions: [
                    { class: 'è‚ºå‡ºè¡€', probability: 0.92 },
                    { class: 'è‚ºæ°´è‚¿', probability: 0.05 },
                    { class: 'è‚ºç‚', probability: 0.03 }
                ]
            }
        };

        const auth = {
            token: localStorage.getItem('token'),
            user: JSON.parse(localStorage.getItem('user') || 'null'),
            isDemo: localStorage.getItem('isDemo') === 'true',

            save(token, user) {
                this.token = token;
                this.user = user;
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(user));
            },

            clear() {
                this.token = null;
                this.user = null;
                this.isDemo = false;
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('isDemo');
            },

            isLoggedIn() {
                return !!this.token || this.isDemo;
            },

            isAdmin() {
                return this.user?.role === 'admin' || this.isDemo;
            },

            enterDemo() {
                this.isDemo = true;
                this.token = 'demo-token';
                this.user = { id: 0, username: 'demo', name: 'æ¼”ç¤ºç”¨æˆ·', role: 'admin' };
                localStorage.setItem('isDemo', 'true');
                localStorage.setItem('token', 'demo-token');
                localStorage.setItem('user', JSON.stringify(this.user));
                router.navigate('home');
            },

            isDemoMode() {
                return this.isDemo;
            }
        };

        const api = {
            // æ¼”ç¤ºæ¨¡å¼è¿”å›æ¨¡æ‹Ÿæ•°æ®
            getMockData(endpoint, options) {
                if (endpoint === '/diagnosis/list') {
                    return Promise.resolve({ success: true, data: MOCK_RECORDS });
                }
                if (endpoint.includes('predict')) {
                    // æ¨¡æ‹Ÿè¯Šæ–­ç»“æœ
                    const diagnoses = ['è‚ºå‡ºè¡€', 'è‚ºæ°´è‚¿', 'è‚ºç‚', 'å† å¿ƒç—…', 'å¿ƒè‚Œç‚', 'è„‘å‡ºè¡€', 'è„‘æ°´è‚¿', 'è‚è„‚è‚ªå˜æ€§'];
                    const types = ['è‚ºéƒ¨ç—…å˜', 'è‚ºéƒ¨ç—…å˜', 'è‚ºéƒ¨ç—…å˜', 'å¿ƒè¡€ç®¡ç—…å˜', 'å¿ƒè¡€ç®¡ç—…å˜', 'è„‘éƒ¨ç—…å˜', 'è„‘éƒ¨ç—…å˜', 'è‚è„ç—…å˜'];
                    const idx = Math.floor(Math.random() * diagnoses.length);
                    const confidence = (0.75 + Math.random() * 0.23).toFixed(2);
                    const mockResult = {
                        success: true,
                        diagnosis_id: Math.floor(Math.random() * 10000) + 1000,
                        prediction: {
                            result: diagnoses[idx],
                            confidence: parseFloat(confidence),
                            diagnosis_type: types[idx],
                            all_predictions: [
                                { class: diagnoses[idx], probability: parseFloat(confidence) },
                                { class: diagnoses[(idx + 1) % diagnoses.length], probability: parseFloat((1 - confidence).toFixed(2)) }
                            ]
                        }
                    };
                    return Promise.resolve(mockResult);
                }
                return Promise.resolve({});
            },

            async request(endpoint, options = {}) {
                // æ¼”ç¤ºæ¨¡å¼è¿”å›æ¨¡æ‹Ÿæ•°æ®
                if (auth.isDemoMode() && endpoint.includes('diagnosis')) {
                    return this.getMockData(endpoint, options);
                }

                const url = `${API_BASE_URL}${endpoint}`;
                const headers = {
                    ...options.headers
                };

                if (auth.token) {
                    headers['Authorization'] = `Bearer ${auth.token}`;
                }

                if (!(options.body instanceof FormData)) {
                    headers['Content-Type'] = 'application/json';
                }

                const response = await fetch(url, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'è¯·æ±‚å¤±è´¥' }));
                    throw new Error(error.error || 'è¯·æ±‚å¤±è´¥');
                }

                return response.json();
            },

            async login(username, password) {
                const data = await this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                auth.save(data.token, data.user);
                return data;
            },

            async register(formData) {
                const data = await this.request('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                auth.save(data.token, data.user);
                return data;
            },

            async logout() {
                auth.clear();
            },

            async getDiagnosisList() {
                const data = await this.request('/diagnosis/list');
                return data.data;
            },

            async predict(formData) {
                const response = await fetch(`${API_BASE_URL}/diagnosis/predict`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${auth.token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'é¢„æµ‹å¤±è´¥' }));
                    throw new Error(error.error || 'é¢„æµ‹å¤±è´¥');
                }

                return response.json();
            },

            async generateReport(id, reportType) {
                const data = await this.request(`/diagnosis/${id}/report`, {
                    method: 'POST',
                    body: JSON.stringify({ report_type: reportType })
                });
                return data;
            },

            async getUsers() {
                const data = await this.request('/users');
                return data.data;
            }
        };

        const views = {
            login: `
                <div class="auth-page">
                    <div class="auth-container">
                        <h1>å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <h2>ç™»å½•</h2>
                        <form id="login-form">
                            <div class="form-group">
                                <label>ç”¨æˆ·å</label>
                                <input type="text" id="login-username" required>
                            </div>
                            <div class="form-group">
                                <label>å¯†ç </label>
                                <input type="password" id="login-password" required>
                            </div>
                            <div id="login-error" class="error-message hidden"></div>
                            <button type="submit" id="login-btn">ç™»å½•</button>
                        </form>
                        <button type="button" class="demo-btn" onclick="auth.enterDemo(); router.navigate('dashboard')">æ¼”ç¤ºä½“éªŒï¼ˆæ— éœ€ç™»å½•ï¼‰</button>
                        <p>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="router.navigate('register')">ç«‹å³æ³¨å†Œ</a></p>
                    </div>
                </div>
            `,

            register: `
                <div class="auth-page">
                    <div class="auth-container">
                        <h1>å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <h2>æ³¨å†Œ</h2>
                        <form id="register-form">
                            <div class="form-group">
                                <label>ç”¨æˆ·å</label>
                                <input type="text" id="register-username" required>
                            </div>
                            <div class="form-group">
                                <label>å§“å</label>
                                <input type="text" id="register-name" required>
                            </div>
                            <div class="form-group">
                                <label>å¯†ç </label>
                                <input type="password" id="register-password" required>
                            </div>
                            <div class="form-group">
                                <label>è§’è‰²</label>
                                <select id="register-role">
                                    <option value="forensic">æ³•åŒ»</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                            <div id="register-error" class="error-message hidden"></div>
                            <button type="submit" id="register-btn">æ³¨å†Œ</button>
                        </form>
                        <p>å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="router.navigate('login')">ç«‹å³ç™»å½•</a></p>
                    </div>
                </div>
            `,

            dashboard: `
                <div class="layout">
                    <header class="header">
                        <h1>å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button class="active" onclick="router.navigate('dashboard')">é¦–é¡µ</button>
                            <button onclick="router.navigate('diagnosis')">è¯Šæ–­</button>
                            <button onclick="router.navigate('history')">å†å²</button>
                            <button id="admin-nav-btn" onclick="router.navigate('admin')" class="hidden">ç®¡ç†</button>
                        </nav>
                        <div class="header-right">
                            <span class="demo-badge" id="demo-badge" style="display:none">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="dashboard">
                            <h2>æ¬¢è¿ä½¿ç”¨å¸æ³•é‰´å®šåŠ©æ‰‹</h2>
                            <div class="stats-cards">
                                <div class="stat-card">
                                    <h3>æ€»è¯Šæ–­æ•°</h3>
                                    <p class="stat-number" id="total-count">0</p>
                                </div>
                                <div class="stat-card">
                                    <h3>å¿«é€Ÿè¯Šæ–­</h3>
                                    <a href="#" class="stat-link" onclick="router.navigate('diagnosis')">å¼€å§‹æ–°è¯Šæ–­</a>
                                </div>
                            </div>
                            <div class="recent-section">
                                <h3>æœ€è¿‘è¯Šæ–­è®°å½•</h3>
                                <div id="recent-records">
                                    <div class="loading">åŠ è½½ä¸­...</div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `,

            diagnosis: `
                <div class="layout">
                    <header class="header">
                        <h1>å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('dashboard')">é¦–é¡µ</button>
                            <button class="active" onclick="router.navigate('diagnosis')">è¯Šæ–­</button>
                            <button onclick="router.navigate('history')">å†å²</button>
                            <button id="admin-nav-btn" onclick="router.navigate('admin')" class="hidden">ç®¡ç†</button>
                        </nav>
                        <div class="header-right">
                            <span class="demo-badge" id="demo-badge" style="display:none">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="diagnosis-page">
                            <h2>ç—…ç†åˆ‡ç‰‡è¯Šæ–­</h2>
                            <form id="diagnosis-form" class="diagnosis-form">
                                <div class="form-section">
                                    <h3>1. ä¸Šä¼ ç—…ç†åˆ‡ç‰‡å›¾åƒ</h3>
                                    <div id="dropzone" class="dropzone">
                                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                                        <div id="preview-container" class="preview-container hidden">
                                            <img id="preview-image" class="preview-image" alt="é¢„è§ˆ">
                                            <button type="button" class="remove-image" onclick="diagnosis.clearFile()">Ã—</button>
                                        </div>
                                        <div id="dropzone-prompt">
                                            <p>æ‹–æ‹½å›¾åƒåˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                                            <p style="font-size: 12px; color: #999;">æ”¯æŒ JPG, PNG, TIFF, BMP æ ¼å¼</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-section">
                                    <h3>2. æ‚£è€…ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>æ‚£è€…å§“å</label>
                                            <input type="text" id="patient-name">
                                        </div>
                                        <div class="form-group">
                                            <label>æ‚£è€…ID</label>
                                            <input type="text" id="patient-id">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>å¤‡æ³¨</label>
                                        <textarea id="patient-notes" rows="3"></textarea>
                                    </div>
                                </div>
                                <div id="diagnosis-error" class="error-message hidden"></div>
                                <div class="form-actions">
                                    <button type="submit" id="diagnosis-btn">å¼€å§‹åˆ†æ</button>
                                    <button type="button" id="reset-btn" class="secondary hidden" onclick="diagnosis.reset()">é‡ç½®</button>
                                </div>
                            </form>
                            <div id="result-section" class="result-section hidden">
                                <h3>è¯Šæ–­ç»“æœ</h3>
                                <div class="result-card">
                                    <div class="result-main">
                                        <h4 id="result-main">ä¸»è¦è¯Šæ–­: -</h4>
                                        <p class="confidence" id="result-confidence">ç½®ä¿¡åº¦: -</p>
                                        <p class="diagnosis-type" id="result-type">è¯Šæ–­ç±»å‹: -</p>
                                    </div>
                                    <div id="result-details" class="result-details hidden">
                                        <h5>å…¶ä»–å¯èƒ½ç»“æœ:</h5>
                                        <ul id="result-predictions"></ul>
                                    </div>
                                    <div class="result-actions">
                                        <button onclick="diagnosis.downloadReport('pdf')">ä¸‹è½½PDFæŠ¥å‘Š</button>
                                        <button onclick="diagnosis.downloadReport('word')" class="secondary">ä¸‹è½½WordæŠ¥å‘Š</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `,

            history: `
                <div class="layout">
                    <header class="header">
                        <h1>å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('dashboard')">é¦–é¡µ</button>
                            <button onclick="router.navigate('diagnosis')">è¯Šæ–­</button>
                            <button class="active" onclick="router.navigate('history')">å†å²</button>
                            <button id="admin-nav-btn" onclick="router.navigate('admin')" class="hidden">ç®¡ç†</button>
                        </nav>
                        <div class="header-right">
                            <span class="demo-badge" id="demo-badge" style="display:none">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="history-page">
                            <h2>è¯Šæ–­å†å²è®°å½•</h2>
                            <div id="history-records">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </main>
                </div>
            `,

            admin: `
                <div class="layout">
                    <header class="header">
                        <h1>å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('dashboard')">é¦–é¡µ</button>
                            <button onclick="router.navigate('diagnosis')">è¯Šæ–­</button>
                            <button onclick="router.navigate('history')">å†å²</button>
                            <button id="admin-nav-btn" onclick="router.navigate('admin')" class="active">ç®¡ç†</button>
                        </nav>
                        <div class="header-right">
                            <span class="demo-badge" id="demo-badge" style="display:none">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="admin-page">
                            <h2>ç”¨æˆ·ç®¡ç†</h2>
                            <div id="admin-content">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </main>
                </div>
            `,

            /* ===== æ–°å¢è§†å›¾ ===== */
            home: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button class="active" onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="home-hero">
                            <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                            <p class="hero-subtitle">æ¹˜é›…å¸æ³•é‰´å®šä¸­å¿ƒåˆä½œå¹³å°</p>
                            <p class="hero-desc">ä¸“ä¸šæ³•åŒ»é‰´å®šè¾…åŠ©å·¥å…·å¹³å°ï¼ŒåŠ©åŠ›æ³•åŒ»å·¥ä½œè€…å’Œå­¦ä¹ è€…æå‡å·¥ä½œæ•ˆç‡</p>
                            <div class="hero-actions">
                                <button onclick="router.navigate('clinical')">å¼€å§‹ä½¿ç”¨</button>
                            </div>
                        </div>
                        <h2 class="section-title">ğŸš€ æ ¸å¿ƒæœåŠ¡å¿«æ·å…¥å£</h2>
                        <div class="stats-cards">
                            <div class="stat-card" onclick="router.navigate('clinical')" style="cursor:pointer">
                                <div style="font-size:32px;margin-bottom:10px">ğŸ¥</div>
                                <h3>è‚‹éª¨éª¨æŠ˜AIåˆ†æ</h3>
                                <p style="font-size:12px;color:#666">ä¸Šä¼ Xå…‰/CTï¼ŒAIæ™ºèƒ½è¯†åˆ«</p>
                                <span class="danger-level high" style="margin-top:10px">AIæ ¸å¿ƒåŠŸèƒ½</span>
                            </div>
                            <div class="stat-card" onclick="router.navigate('pathology')" style="cursor:pointer">
                                <div style="font-size:32px;margin-bottom:10px">ğŸ”¬</div>
                                <h3>ç—…ç†åˆ‡ç‰‡AIåˆ†æ</h3>
                                <p style="font-size:12px;color:#666">ä¸Šä¼ ç—…ç†å›¾åƒï¼Œæ™ºèƒ½åˆ†æ</p>
                                <span class="danger-level high" style="margin-top:10px">AIæ ¸å¿ƒåŠŸèƒ½</span>
                            </div>
                            <div class="stat-card" onclick="router.navigate('clinical')" style="cursor:pointer">
                                <div style="font-size:32px;margin-bottom:10px">ğŸ“‹</div>
                                <h3>ä¼¤æƒ…è‡ªæµ‹å·¥å…·</h3>
                                <p style="font-size:12px;color:#666">æ ¹æ®ç—‡çŠ¶åˆæ­¥è¯„ä¼°</p>
                            </div>
                            <div class="stat-card" onclick="router.navigate('expert')" style="cursor:pointer">
                                <div style="font-size:32px;margin-bottom:10px">ğŸ‘¨â€âš•ï¸</div>
                                <h3>ä¸“å®¶å’¨è¯¢</h3>
                                <p style="font-size:12px;color:#666">è”ç³»èµ„æ·±æ³•åŒ»ä¸“å®¶</p>
                            </div>
                        </div>
                        <h2 class="section-title">ğŸ—‚ï¸ åŠŸèƒ½æ¿å—å¯¼èˆª</h2>
                        <div class="stats-cards">
                            <div class="stat-card" onclick="router.navigate('clinical')" style="cursor:pointer"><h3>ğŸ¥ æ³•åŒ»ä¸´åºŠ</h3><p style="font-size:12px;color:#666">æ´»ä½“æŸä¼¤é‰´å®šè¾…åŠ©å·¥å…·åº“</p></div>
                            <div class="stat-card" onclick="router.navigate('pathology')" style="cursor:pointer"><h3>ğŸ”¬ æ³•åŒ»ç—…ç†</h3><p style="font-size:12px;color:#666">æ­»å› é‰´å®šè¾…åŠ©å·¥å…·åº“</p></div>
                            <div class="stat-card" onclick="router.navigate('toxicology')" style="cursor:pointer"><h3>â˜ ï¸ æ³•åŒ»æ¯’ç‰©</h3><p style="font-size:12px;color:#666">æ¯’ç‰©åˆ†æè¾…åŠ©ä¸çŸ¥è¯†åº“</p></div>
                            <div class="stat-card" onclick="router.navigate('psychiatry')" style="cursor:pointer"><h3>ğŸ§  æ³•åŒ»ç²¾ç¥ç—…</h3><p style="font-size:12px;color:#666">ç²¾ç¥çŠ¶æ€é‰´å®šè¾…åŠ©çŸ¥è¯†</p></div>
                            <div class="stat-card" onclick="router.navigate('evidence')" style="cursor:pointer"><h3>ğŸ§¬ æ³•åŒ»ç‰©è¯</h3><p style="font-size:12px;color:#666">ç”Ÿç‰©æ£€ææ£€éªŒè¾…åŠ©çŸ¥è¯†</p></div>
                            <div class="stat-card" onclick="router.navigate('expert')" style="cursor:pointer"><h3>ğŸ‘¨â€âš•ï¸ ä¸“å®¶å’¨è¯¢</h3><p style="font-size:12px;color:#666">ä»˜è´¹å’¨è¯¢ä¸šåŠ¡ä¸»é˜µåœ°</p></div>
                        </div>
                    </main>
                </div>
            `,

            clinical: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button class="active" onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="page-with-sidebar">
                            <aside class="sidebar">
                                <h3 class="sidebar-title">æ³•åŒ»ä¸´åºŠ</h3>
                                <ul class="sidebar-menu">
                                    <li><a href="#" class="active" onclick="clinical.setSection('rib-fracture')">ğŸ¥ è‚‹éª¨éª¨æŠ˜AIè¯Šæ–­</a></li>
                                    <li><a href="#" onclick="clinical.setSection('injury-self-test')">ğŸ“‹ ä¼¤æƒ…è‡ªæµ‹</a></li>
                                    <li><a href="#" onclick="clinical.setSection('nursing-assessment')">ğŸ©º æŠ¤ç†ç¨‹åº¦è¯„ä¼°</a></li>
                                    <li><a href="#" onclick="clinical.setSection('clinical-tools')">ğŸ”§ ä¸´åºŠå·¥å…·</a></li>
                                    <li><a href="#" onclick="clinical.setSection('ä¸‰æœŸæ¨è')">ğŸ“… ä¸‰æœŸæ¨è</a></li>
                                    <li><a href="#" onclick="clinical.setSection('standards')">ğŸ“š æŠ€æœ¯æ ‡å‡†</a></li>
                                </ul>
                            </aside>
                            <div class="page-content" id="clinical-content"></div>
                        </div>
                    </main>
                </div>
            `,

            pathology: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button class="active" onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="page-with-sidebar">
                            <aside class="sidebar">
                                <h3 class="sidebar-title">æ³•åŒ»ç—…ç†</h3>
                                <ul class="sidebar-menu">
                                    <li><a href="#" class="active" onclick="pathology.setSection('ai-diagnosis')">ğŸ”¬ AIè¾…åŠ©è¯Šæ–­</a></li>
                                    <li><a href="#" onclick="pathology.setSection('organ-weight')">âš–ï¸ å™¨å®˜é‡é‡å‚è€ƒ</a></li>
                                    <li><a href="#" onclick="pathology.setSection('pmi')">â° PMIä¼°ç®—</a></li>
                                    <li><a href="#" onclick="pathology.setSection('standards')">ğŸ“š æŠ€æœ¯æ ‡å‡†</a></li>
                                </ul>
                            </aside>
                            <div class="page-content" id="pathology-content"></div>
                        </div>
                    </main>
                </div>
            `,

            toxicology: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button class="active" onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="page-with-sidebar">
                            <aside class="sidebar">
                                <h3 class="sidebar-title">æ³•åŒ»æ¯’ç‰©</h3>
                                <ul class="sidebar-menu">
                                    <li><a href="#" class="active" onclick="toxicology.setSection('toxin-search')">ğŸ” æ¯’ç‰©é€ŸæŸ¥æ‰‹å†Œ</a></li>
                                    <li><a href="#" onclick="toxicology.setSection('alcohol-calc')">ğŸº è¡€æ¶²é…’ç²¾æµ“åº¦ä¼°ç®—</a></li>
                                    <li><a href="#" onclick="toxicology.setSection('standards')">ğŸ“š æŠ€æœ¯æ ‡å‡†</a></li>
                                </ul>
                            </aside>
                            <div class="page-content" id="toxicology-content"></div>
                        </div>
                    </main>
                </div>
            `,

            psychiatry: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button class="active" onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="page-with-sidebar">
                            <aside class="sidebar">
                                <h3 class="sidebar-title">æ³•åŒ»ç²¾ç¥ç—…</h3>
                                <ul class="sidebar-menu">
                                    <li><a href="#" class="active" onclick="psychiatry.setSection('self-care')">ğŸ§  ç²¾ç¥éšœç¢ç”Ÿæ´»è‡ªç†è¯„ä¼°</a></li>
                                    <li><a href="#" onclick="psychiatry.setSection('standards')">ğŸ“š æŠ€æœ¯æ ‡å‡†</a></li>
                                </ul>
                            </aside>
                            <div class="page-content" id="psychiatry-content"></div>
                        </div>
                    </main>
                </div>
            `,

            evidence: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button class="active" onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="page-with-sidebar">
                            <aside class="sidebar">
                                <h3 class="sidebar-title">æ³•åŒ»ç‰©è¯</h3>
                                <ul class="sidebar-menu">
                                    <li><a href="#" class="active" onclick="evidence.setSection('dna-basic')">ğŸ§¬ DNAæ£€éªŒåŸºç¡€çŸ¥è¯†</a></li>
                                    <li><a href="#" onclick="evidence.setSection('str')">ğŸ“Š STRåˆ†å‹</a></li>
                                    <li><a href="#" onclick="evidence.setSection('paternity')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ äº²å­é‰´å®š</a></li>
                                    <li><a href="#" onclick="evidence.setSection('mixed')">ğŸ”¬ æ··åˆæ–‘è§£è¯»</a></li>
                                    <li><a href="#" onclick="evidence.setSection('standards')">ğŸ“š æŠ€æœ¯æ ‡å‡†</a></li>
                                </ul>
                            </aside>
                            <div class="page-content" id="evidence-content"></div>
                        </div>
                    </main>
                </div>
            `,

            expert: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button class="active" onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="page-header">
                            <h1>ğŸ‘¨â€âš•ï¸ ä¸“å®¶å’¨è¯¢</h1>
                            <p>è”ç³»èµ„æ·±æ³•åŒ»ä¸“å®¶ï¼Œè·å–ä¸“ä¸šé‰´å®šæ„è§</p>
                        </div>
                        <div class="tabs">
                            <div class="tab active" onclick="expert.setTab('experts')">ä¸“å®¶åˆ—è¡¨</div>
                            <div class="tab" onclick="expert.setTab('qa')">åœ¨çº¿é—®ç­”</div>
                            <div class="tab" onclick="expert.setTab('booking')">é¢„çº¦å’¨è¯¢</div>
                            <div class="tab" onclick="expert.setTab('history')">å’¨è¯¢è®°å½•</div>
                        </div>
                        <div id="expert-content"></div>
                    </main>
                </div>
            `,

            profile: `
                <div class="layout">
                    <header class="header">
                        <h1>âš–ï¸ å¸æ³•é‰´å®šåŠ©æ‰‹</h1>
                        <nav class="nav">
                            <button onclick="router.navigate('home')">é¦–é¡µ</button>
                            <button onclick="router.navigate('clinical')">æ³•åŒ»ä¸´åºŠ</button>
                            <button onclick="router.navigate('pathology')">æ³•åŒ»ç—…ç†</button>
                            <button onclick="router.navigate('toxicology')">æ³•åŒ»æ¯’åŒ–</button>
                            <button onclick="router.navigate('psychiatry')">æ³•åŒ»ç²¾ç¥ç—…</button>
                            <button onclick="router.navigate('evidence')">æ³•åŒ»ç‰©è¯</button>
                            <button onclick="router.navigate('expert')">ä¸“å®¶å’¨è¯¢</button>
                            <button class="active" onclick="router.navigate('profile')">ä¸ªäººä¸­å¿ƒ</button>
                        </nav>
                        <div class="header-right">
                            <span class="user-info" id="user-display"></span>
                            <button class="logout-btn" onclick="auth.clear(); router.navigate('login')">é€€å‡º</button>
                        </div>
                    </header>
                    <main class="main-content">
                        <div class="profile-header">
                            <div class="profile-avatar">${auth.user?.name?.charAt(0) || 'U'}</div>
                            <div class="profile-info">
                                <h2>${auth.user?.name || 'ç”¨æˆ·'}</h2>
                                <p>${auth.user?.role === 'admin' ? 'ç®¡ç†å‘˜' : auth.user?.role === 'expert' ? 'ä¸“å®¶' : auth.user?.role === 'forensic' ? 'æ³•åŒ»' : 'æ™®é€šç”¨æˆ·'}</p>
                            </div>
                            <div class="profile-stats">
                                <div class="profile-stat"><div class="number">4</div><div class="label">åˆ†æè®°å½•</div></div>
                                <div class="profile-stat"><div class="number">2</div><div class="label">å’¨è¯¢è®°å½•</div></div>
                                <div class="profile-stat"><div class="number">4</div><div class="label">æ”¶è—</div></div>
                            </div>
                        </div>
                        <div class="tabs">
                            <div class="tab active" onclick="profile.setTab('analyses')">æˆ‘çš„åˆ†æ</div>
                            <div class="tab" onclick="profile.setTab('consults')">æˆ‘çš„å’¨è¯¢</div>
                            <div class="tab" onclick="profile.setTab('favorites')">æˆ‘çš„æ”¶è—</div>
                            <div class="tab" onclick="profile.setTab('settings')">è´¦å·è®¾ç½®</div>
                        </div>
                        <div id="profile-content"></div>
                    </main>
                </div>
            `
        };

        const router = {
            currentView: 'login',

            navigate(view) {
                if (!auth.isLoggedIn() && view !== 'login' && view !== 'register') {
                    this.navigate('login');
                    return;
                }

                if (auth.isLoggedIn() && (view === 'login' || view === 'register')) {
                    this.navigate('home');
                    return;
                }

                this.currentView = view;
                this.render();
            },

            render() {
                const app = document.getElementById('app');
                
                if (!auth.isLoggedIn()) {
                    if (this.currentView === 'register') {
                        app.innerHTML = views.register;
                        this.attachRegisterListeners();
                    } else {
                        app.innerHTML = views.login;
                        this.attachLoginListeners();
                    }
                    return;
                }

                app.innerHTML = views[this.currentView] || views.home;
                this.attachCommonListeners();

                switch (this.currentView) {
                    case 'home':
                        break;
                    case 'clinical':
                        clinical.init();
                        break;
                    case 'pathology':
                        pathology.init();
                        break;
                    case 'toxicology':
                        toxicology.init();
                        break;
                    case 'psychiatry':
                        psychiatry.init();
                        break;
                    case 'evidence':
                        evidence.init();
                        break;
                    case 'expert':
                        expert.init();
                        break;
                    case 'profile':
                        profile.init();
                        break;
                    case 'dashboard':
                        dashboard.load();
                        break;
                    case 'diagnosis':
                        diagnosis.init();
                        break;
                    case 'history':
                        history.load();
                        break;
                    case 'admin':
                        if (!auth.isAdmin()) {
                            document.querySelector('.admin-page').innerHTML = '<div class="access-denied">æ— æƒè®¿é—®æ­¤é¡µé¢</div>';
                        } else {
                            admin.load();
                        }
                        break;
                }
            },

            attachLoginListeners() {
                const form = document.getElementById('login-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const username = document.getElementById('login-username').value;
                        const password = document.getElementById('login-password').value;
                        const btn = document.getElementById('login-btn');
                        const error = document.getElementById('login-error');

                        btn.disabled = true;
                        btn.textContent = 'ç™»å½•ä¸­...';
                        error.classList.add('hidden');

                        try {
                            await api.login(username, password);
                            router.navigate('home');
                        } catch (err) {
                            error.textContent = err.message;
                            error.classList.remove('hidden');
                        } finally {
                            btn.disabled = false;
                            btn.textContent = 'ç™»å½•';
                        }
                    });
                }
            },

            attachRegisterListeners() {
                const form = document.getElementById('register-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = {
                            username: document.getElementById('register-username').value,
                            name: document.getElementById('register-name').value,
                            password: document.getElementById('register-password').value,
                            role: document.getElementById('register-role').value
                        };
                        const btn = document.getElementById('register-btn');
                        const error = document.getElementById('register-error');

                        btn.disabled = true;
                        btn.textContent = 'æ³¨å†Œä¸­...';
                        error.classList.add('hidden');

                        try {
                            await api.register(formData);
                            router.navigate('home');
                        } catch (err) {
                            error.textContent = err.message;
                            error.classList.remove('hidden');
                        } finally {
                            btn.disabled = false;
                            btn.textContent = 'æ³¨å†Œ';
                        }
                    });
                }
            },

            attachCommonListeners() {
                const userDisplay = document.getElementById('user-display');
                if (userDisplay) {
                    userDisplay.textContent = auth.user?.name || auth.user?.username || '';
                }

                const adminNavBtn = document.getElementById('admin-nav-btn');
                if (adminNavBtn) {
                    if (auth.isAdmin()) {
                        adminNavBtn.classList.remove('hidden');
                    } else {
                        adminNavBtn.classList.add('hidden');
                    }
                }

                // æ¼”ç¤ºæ¨¡å¼æ ‡è¯†æ˜¾ç¤º/éšè—
                const demoBadge = document.getElementById('demo-badge');
                if (demoBadge) {
                    demoBadge.style.display = auth.isDemoMode() ? 'inline' : 'none';
                }
            }
        };

        const dashboard = {
            async load() {
                try {
                    const records = await api.getDiagnosisList();
                    document.getElementById('total-count').textContent = records.length;
                    
                    const container = document.getElementById('recent-records');
                    if (records.length === 0) {
                        container.innerHTML = '<div class="empty-state">æš‚æ— è¯Šæ–­è®°å½•</div>';
                        return;
                    }

                    const recent = records.slice(0, 5);
                    container.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ç¼–å·</th>
                                    <th>æ‚£è€…</th>
                                    <th>è¯Šæ–­ç»“æœ</th>
                                    <th>ç½®ä¿¡åº¦</th>
                                    <th>æ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recent.map(item => `
                                    <tr>
                                        <td>${item.id}</td>
                                        <td>${item.patient_name || '-'}</td>
                                        <td>${item.prediction_result}</td>
                                        <td>${(item.confidence * 100).toFixed(1)}%</td>
                                        <td>${new Date(item.created_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } catch (err) {
                    document.getElementById('recent-records').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
                }
            }
        };

        const diagnosis = {
            file: null,
            result: null,

            init() {
                this.setupDropzone();
                this.setupForm();
            },

            setupDropzone() {
                const dropzone = document.getElementById('dropzone');
                const fileInput = document.getElementById('file-input');

                dropzone.addEventListener('click', () => fileInput.click());

                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('active');
                });

                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('active');
                });

                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('active');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });
            },

            handleFile(file) {
                if (!file.type.startsWith('image/')) {
                    this.showError('è¯·ä¸Šä¼ å›¾åƒæ–‡ä»¶');
                    return;
                }

                this.file = file;
                this.result = null;

                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('dropzone-prompt').classList.add('hidden');
                };
                reader.readAsDataURL(file);

                this.hideError();
                document.getElementById('result-section').classList.add('hidden');
            },

            clearFile() {
                this.file = null;
                this.result = null;
                document.getElementById('file-input').value = '';
                document.getElementById('preview-container').classList.add('hidden');
                document.getElementById('dropzone-prompt').classList.remove('hidden');
                document.getElementById('result-section').classList.add('hidden');
            },

            setupForm() {
                const form = document.getElementById('diagnosis-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.submit();
                });
            },

            async submit() {
                if (!this.file) {
                    this.showError('è¯·ä¸Šä¼ ç—…ç†åˆ‡ç‰‡å›¾åƒ');
                    return;
                }

                const btn = document.getElementById('diagnosis-btn');
                btn.disabled = true;
                btn.textContent = 'åˆ†æä¸­...';
                this.hideError();

                const formData = new FormData();
                formData.append('image', this.file);
                formData.append('patient_name', document.getElementById('patient-name').value);
                formData.append('patient_id', document.getElementById('patient-id').value);
                formData.append('notes', document.getElementById('patient-notes').value);

                try {
                    this.result = await api.predict(formData);
                    this.showResult();
                    document.getElementById('reset-btn').classList.remove('hidden');
                } catch (err) {
                    this.showError(err.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'å¼€å§‹åˆ†æ';
                }
            },

            showResult() {
                document.getElementById('result-section').classList.remove('hidden');
                document.getElementById('result-main').textContent = `ä¸»è¦è¯Šæ–­: ${this.result.prediction?.result || '-'}`;
                document.getElementById('result-confidence').textContent = `ç½®ä¿¡åº¦: ${((this.result.prediction?.confidence || 0) * 100).toFixed(2)}%`;
                document.getElementById('result-type').textContent = `è¯Šæ–­ç±»å‹: ${this.result.prediction?.diagnosis_type || '-'}`;

                const details = document.getElementById('result-details');
                const predictions = document.getElementById('result-predictions');
                
                if (this.result.prediction?.all_predictions?.length > 0) {
                    details.classList.remove('hidden');
                    predictions.innerHTML = this.result.prediction.all_predictions.slice(0, 5).map(item => `
                        <li>${item.class}: ${(item.probability * 100).toFixed(2)}%</li>
                    `).join('');
                } else {
                    details.classList.add('hidden');
                }
            },

            async downloadReport(reportType) {
                if (!this.result?.diagnosis_id) return;

                try {
                    const res = await api.generateReport(this.result.diagnosis_id, reportType);
                    const response = await fetch(res.download_url);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è¯Šæ–­æŠ¥å‘Š_${this.result.diagnosis_id}.${reportType}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (err) {
                    this.showError('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
                }
            },

            reset() {
                this.clearFile();
                document.getElementById('patient-name').value = '';
                document.getElementById('patient-id').value = '';
                document.getElementById('patient-notes').value = '';
                document.getElementById('reset-btn').classList.add('hidden');
            },

            showError(msg) {
                const error = document.getElementById('diagnosis-error');
                error.textContent = msg;
                error.classList.remove('hidden');
            },

            hideError() {
                document.getElementById('diagnosis-error').classList.add('hidden');
            }
        };

        const history = {
            records: [],
            selectedRecord: null,

            async load() {
                try {
                    this.records = await api.getDiagnosisList();
                    this.render();
                } catch (err) {
                    document.getElementById('history-records').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
                }
            },

            render() {
                const container = document.getElementById('history-records');
                
                if (this.records.length === 0) {
                    container.innerHTML = '<div class="empty-state">æš‚æ— è¯Šæ–­è®°å½•</div>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç¼–å·</th>
                                <th>æ‚£è€…å§“å</th>
                                <th>æ‚£è€…ID</th>
                                <th>è¯Šæ–­ç»“æœ</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>è¯Šæ–­ç±»å‹</th>
                                <th>æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.records.map(record => `
                                <tr>
                                    <td>${record.id}</td>
                                    <td>${record.patient_name || '-'}</td>
                                    <td>${record.patient_id || '-'}</td>
                                    <td>${record.prediction_result}</td>
                                    <td>${(record.confidence * 100).toFixed(1)}%</td>
                                    <td>${record.diagnosis_type || '-'}</td>
                                    <td>${new Date(record.created_at).toLocaleString()}</td>
                                    <td class="actions">
                                        <button onclick="history.showDetail(${record.id})">æŸ¥çœ‹</button>
                                        <button onclick="history.downloadReport(${record.id}, 'pdf')">PDF</button>
                                        <button onclick="history.downloadReport(${record.id}, 'word')">Word</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            },

            showDetail(id) {
                this.selectedRecord = this.records.find(r => r.id === id);
                if (!this.selectedRecord) return;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" onclick="event.stopPropagation()">
                        <h3>è¯Šæ–­è¯¦æƒ…</h3>
                        <div class="detail-content">
                            <div class="detail-row">
                                <span class="label">è¯Šæ–­ç¼–å·:</span>
                                <span class="value">${this.selectedRecord.id}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">æ‚£è€…å§“å:</span>
                                <span class="value">${this.selectedRecord.patient_name || 'æœªå¡«å†™'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">æ‚£è€…ID:</span>
                                <span class="value">${this.selectedRecord.patient_id || 'æœªå¡«å†™'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">è¯Šæ–­ç»“æœ:</span>
                                <span class="value">${this.selectedRecord.prediction_result}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">ç½®ä¿¡åº¦:</span>
                                <span class="value">${(this.selectedRecord.confidence * 100).toFixed(2)}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">è¯Šæ–­ç±»å‹:</span>
                                <span class="value">${this.selectedRecord.diagnosis_type || '-'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">åŒ»å¸ˆå¤‡æ³¨:</span>
                                <span class="value">${this.selectedRecord.notes || 'æ— '}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">è¯Šæ–­æ—¶é—´:</span>
                                <span class="value">${new Date(this.selectedRecord.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button onclick="history.downloadReport(${this.selectedRecord.id}, 'pdf')">ä¸‹è½½PDF</button>
                            <button onclick="history.downloadReport(${this.selectedRecord.id}, 'word')" class="secondary">ä¸‹è½½Word</button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="secondary">å…³é—­</button>
                        </div>
                    </div>
                `;
                modal.addEventListener('click', () => modal.remove());
                document.body.appendChild(modal);
            },

            async downloadReport(id, reportType) {
                try {
                    const res = await api.generateReport(id, reportType);
                    const response = await fetch(res.download_url);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è¯Šæ–­æŠ¥å‘Š_${id}.${reportType}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (err) {
                    alert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
                }
            }
        };

        const admin = {
            async load() {
                try {
                    const users = await api.getUsers();
                    this.render(users);
                } catch (err) {
                    document.getElementById('admin-content').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
                }
            },

            render(users) {
                const container = document.getElementById('admin-content');
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>å§“å</th>
                                <th>è§’è‰²</th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr>
                                    <td>${u.id}</td>
                                    <td>${u.username}</td>
                                    <td>${u.name}</td>
                                    <td>${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ³•åŒ»'}</td>
                                    <td>${new Date(u.created_at).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        };

        /* ===== æ–°å¢åŠŸèƒ½æ¨¡å— ===== */
        const clinical = {
            currentSection: 'rib-fracture',
            file: null,
            
            init() { this.render(); },
            
            setSection(section) {
                this.currentSection = section;
                this.render();
            },
            
            render() {
                const container = document.getElementById('clinical-content');
                switch(this.currentSection) {
                    case 'rib-fracture':
                        container.innerHTML = this.ribFractureView();
                        this.setupRibFracture();
                        break;
                    case 'injury-self-test':
                        container.innerHTML = this.injurySelfTestView();
                        break;
                    case 'nursing-assessment':
                        container.innerHTML = this.nursingAssessmentView();
                        break;
                    case 'clinical-tools':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ”§ ä¸´åºŠå·¥å…·</h2><p style="color:#666">è¯¥åŠŸèƒ½å¼€å‘ä¸­...</p></div>';
                        break;
                    case 'ä¸‰æœŸæ¨è':
                        container.innerHTML = this.threePeriodView();
                        break;
                    case 'standards':
                        container.innerHTML = this.standardsView();
                        break;
                }
            },
            
            ribFractureView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ¥ AIè¾…åŠ©è‚‹éª¨éª¨æŠ˜è¯Šæ–­</h2>
                        <p style="color:#666;margin-bottom:20px">ä¸Šä¼ Xå…‰æˆ–CTå›¾ç‰‡ï¼ŒAIæ™ºèƒ½è¯†åˆ«éª¨æŠ˜ä½ç½®ã€æ•°é‡å¹¶ä¼°ç®—éª¨æŠ˜æ—¶é—´</p>
                        <div class="upload-zone" id="rib-dropzone">
                            <div class="upload-icon">ğŸ“¤</div>
                            <p>æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ Xå…‰/CTå›¾ç‰‡</p>
                            <p class="hint">æ”¯æŒ PNGã€JPG æ ¼å¼</p>
                        </div>
                        <div class="form-actions" style="margin-top:20px">
                            <button onclick="clinical.analyzeRib()">å¼€å§‹åˆ†æ</button>
                        </div>
                        <div id="rib-result"></div>
                    </div>
                `;
            },
            
            setupRibFracture() {
                const dropzone = document.getElementById('rib-dropzone');
                if(!dropzone) return;
                dropzone.onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        if(e.target.files[0]) {
                            this.file = e.target.files[0];
                            dropzone.innerHTML = '<img src="' + URL.createObjectURL(this.file) + '" class="upload-preview">';
                        }
                    };
                    input.click();
                };
            },
            
            analyzeRib() {
                if(!this.file) { alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡'); return; }
                const result = {
                    prediction_result: 'è‚‹éª¨éª¨æŠ˜',
                    confidence: 0.92,
                    details: { fracture_count: 3, positions: ['å·¦ä¾§ç¬¬4è‚‹', 'å·¦ä¾§ç¬¬5è‚‹', 'å·¦ä¾§ç¬¬6è‚‹'], timing: 'æ–°é²œéª¨æŠ˜ï¼ˆçº¦1-2å‘¨ï¼‰' }
                };
                document.getElementById('rib-result').innerHTML = `
                    <div class="calculator-result">
                        <h4>ğŸ“‹ è¯Šæ–­ç»“æœ</h4>
                        <p><strong>è¯Šæ–­ç±»å‹:</strong> ${result.prediction_result}</p>
                        <p><strong>ç½®ä¿¡åº¦:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                        <p><strong>éª¨æŠ˜æ•°é‡:</strong> ${result.details.fracture_count} å¤„</p>
                        <p><strong>éª¨æŠ˜ä½ç½®:</strong> ${result.details.positions.join('ã€')}</p>
                        <p><strong>éª¨æŠ˜æ—¶é—´:</strong> ${result.details.timing}</p>
                    </div>
                `;
            },
            
            injurySelfTestView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ“‹ ä¼¤æƒ…è‡ªæµ‹é—®å·</h2>
                        <p style="color:#666;margin-bottom:20px">æ ¹æ®ç—‡çŠ¶åˆæ­¥è¯„ä¼°æŸä¼¤ç¨‹åº¦ï¼Œä»…ä¾›å‚è€ƒ</p>
                        <div class="form-group"><label>ç–¼ç—›ç¨‹åº¦</label><select id="pain-level"><option value="">è¯·é€‰æ‹©</option><option>è½»åº¦</option><option>ä¸­åº¦</option><option>é‡åº¦</option></select></div>
                        <div class="form-group"><label>è‚¿èƒ€æƒ…å†µ</label><select id="swelling"><option value="">è¯·é€‰æ‹©</option><option>æ— è‚¿èƒ€</option><option>è½»å¾®è‚¿èƒ€</option><option>æ˜æ˜¾è‚¿èƒ€</option></select></div>
                        <div class="form-group"><label>æ´»åŠ¨å—é™</label><select id="movement"><option value="">è¯·é€‰æ‹©</option><option>æ— å—é™</option><option>è½»åº¦å—é™</option><option>ä¸­åº¦å—é™</option></select></div>
                        <div class="form-actions"><button onclick="alert('è¯„ä¼°ç»“æœï¼šå»ºè®®å°±åŒ»æ£€æŸ¥')">æäº¤è¯„ä¼°</button></div>
                    </div>
                `;
            },
            
            nursingAssessmentView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ©º æŠ¤ç†ä¾èµ–ç¨‹åº¦è¯„ä¼°</h2>
                        <p style="color:#666;margin-bottom:20px">æ ¹æ®æ—¥å¸¸ç”Ÿæ´»æ´»åŠ¨èƒ½åŠ›è¯„ä¼°æŠ¤ç†ä¾èµ–ç¨‹åº¦</p>
                        <div class="form-group"><label>å¹´é¾„</label><input type="number" id="nursing-age" placeholder="è¯·è¾“å…¥å¹´é¾„"></div>
                        <div class="form-group"><label>è¿›é£Ÿ</label><select id="nursing-feeding"><option value="">è¯·é€‰æ‹©</option><option>å®Œå…¨è‡ªç†</option><option>éƒ¨åˆ†éœ€å¸®åŠ©</option><option>å®Œå…¨ä¾èµ–</option></select></div>
                        <div class="form-group"><label>ç©¿è¡£</label><select id="nursing-dressing"><option value="">è¯·é€‰æ‹©</option><option>å®Œå…¨è‡ªç†</option><option>éƒ¨åˆ†éœ€å¸®åŠ©</option><option>å®Œå…¨ä¾èµ–</option></select></div>
                        <div class="form-actions"><button onclick="alert('è¯„ä¼°ç»“æœï¼šäºŒçº§æŠ¤ç†ä¾èµ–')">è®¡ç®—è¯„ä¼°</button></div>
                    </div>
                `;
            },
            
            threePeriodView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ“… ä¸‰æœŸï¼ˆè¯¯å·¥æœŸã€æŠ¤ç†æœŸã€è¥å…»æœŸï¼‰æ¨è</h2>
                        <div class="form-group">
                            <label>æŸä¼¤ç±»å‹</label>
                            <select id="injury-type"><option value="">è¯·é€‰æ‹©</option><option>è‚‹éª¨éª¨æŠ˜</option><option>å››è‚¢éª¨æŠ˜</option><option>é¢…è„‘æŸä¼¤</option></select>
                        </div>
                        <div class="form-group">
                            <label>æŸä¼¤ç¨‹åº¦</label>
                            <select id="severity"><option value="">è¯·é€‰æ‹©</option><option>è½»å¾®</option><option>ä¸­ç­‰</option><option>ä¸¥é‡</option></select>
                        </div>
                        <div class="form-actions"><button onclick="document.getElementById('three-period-result').innerHTML = '<div class=calculator-result><h4>æ¨èä¸‰æœŸ</h4><p><strong>è¯¯å·¥æœŸ:</strong> 60-90å¤©</p><p><strong>æŠ¤ç†æœŸ:</strong> 30å¤©</p><p><strong>è¥å…»æœŸ:</strong> 45å¤©</p></div>'">è·å–æ¨è</button></div>
                        <div id="three-period-result"></div>
                    </div>
                `;
            },
            
            standardsView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ“š æ³•åŒ»ä¸´åºŠæŠ€æœ¯æ ‡å‡†</h2>
                        <div class="standard-card"><h3>ã€Šäººä½“æŸä¼¤ç¨‹åº¦é‰´å®šæ ‡å‡†ã€‹</h3><p>2014å¹´å®æ–½çš„æ ‡å‡†ï¼Œç”¨äºç¡®å®šäººä½“æŸä¼¤ç¨‹åº¦</p></div>
                        <div class="standard-card"><h3>ã€Šé“è·¯äº¤é€šäº‹æ•…å—ä¼¤äººå‘˜ä¼¤æ®‹è¯„å®šã€‹</h3><p>GB 18667-2002 é“è·¯äº¤é€šäº‹æ•…ä¼¤æ®‹è¯„å®šæ ‡å‡†</p></div>
                        <div class="standard-card"><h3>ã€ŠåŠ³åŠ¨èƒ½åŠ›é‰´å®š èŒå·¥å·¥ä¼¤ä¸èŒä¸šç—…è‡´æ®‹ç­‰çº§ã€‹</h3><p>GB/T 16180-2014 å·¥ä¼¤ä¼¤æ®‹è¯„å®šæ ‡å‡†</p></div>
                    </div>
                `;
            }
        };

        const pathology = {
            currentSection: 'ai-diagnosis',
            file: null,
            
            init() { this.render(); },
            setSection(section) { this.currentSection = section; this.render(); },
            
            render() {
                const container = document.getElementById('pathology-content');
                switch(this.currentSection) {
                    case 'ai-diagnosis':
                        container.innerHTML = this.aiDiagnosisView();
                        this.setupPathologyUpload();
                        break;
                    case 'organ-weight':
                        container.innerHTML = this.organWeightView();
                        break;
                    case 'pmi':
                        container.innerHTML = this.pmiView();
                        break;
                    case 'standards':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ“š æŠ€æœ¯æ ‡å‡†</h2><div class="standard-card"><h3>ã€Šæ³•åŒ»ç—…ç†æ£€éªŒè§„èŒƒã€‹GA/T 148-1996</h3></div></div>';
                        break;
                }
            },
            
            aiDiagnosisView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ”¬ AIè¾…åŠ©æŸä¼¤ç—…ç†åˆ‡ç‰‡è¯Šæ–­</h2>
                        <p style="color:#666;margin-bottom:20px">ä¸Šä¼ ç—…ç†åˆ‡ç‰‡å›¾åƒï¼ŒAIæ™ºèƒ½åˆ†æå¯èƒ½çš„ç»„ç»‡ç±»å‹ã€æŸä¼¤ç‰¹å¾</p>
                        <div class="upload-zone" id="pathology-dropzone">
                            <div class="upload-icon">ğŸ“¤</div>
                            <p>æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ ç—…ç†åˆ‡ç‰‡å›¾åƒ</p>
                            <p class="hint">æ”¯æŒ PNGã€JPGã€TIF æ ¼å¼</p>
                        </div>
                        <div class="form-actions" style="margin-top:20px"><button onclick="pathology.analyze()">å¼€å§‹åˆ†æ</button></div>
                        <div id="pathology-result"></div>
                    </div>
                `;
            },
            
            setupPathologyUpload() {
                const dropzone = document.getElementById('pathology-dropzone');
                if(!dropzone) return;
                dropzone.onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        if(e.target.files[0]) {
                            this.file = e.target.files[0];
                            dropzone.innerHTML = '<img src="' + URL.createObjectURL(this.file) + '" class="upload-preview">';
                        }
                    };
                    input.click();
                };
            },
            
            analyze() {
                if(!this.file) { alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡'); return; }
                document.getElementById('pathology-result').innerHTML = `
                    <div class="calculator-result">
                        <h4>ğŸ“‹ åˆ†æç»“æœ</h4>
                        <p><strong>è¯Šæ–­ç±»å‹:</strong> æŸä¼¤ç—…ç†æ”¹å˜</p>
                        <p><strong>ç½®ä¿¡åº¦:</strong> 89.0%</p>
                        <p><strong>ç»„ç»‡ç±»å‹:</strong> è‚ºç»„ç»‡</p>
                        <p><strong>å½¢æ€å­¦å‘ç°:</strong> è‚ºæ³¡å£æ–­è£‚ã€è‚ºæ°”è‚¿æ”¹å˜ã€è½»åº¦ç‚ç—‡ç»†èƒæµ¸æ¶¦</p>
                    </div>
                `;
            },
            
            organWeightView() {
                return `
                    <div class="form-card">
                        <h2>âš–ï¸ å™¨å®˜é‡é‡å‚è€ƒ</h2>
                        <div class="calculator-result">
                            <h4>æˆå¹´ç”·æ€§</h4>
                            <div class="result-item"><span class="label">å¿ƒè„</span><span class="value">250-350g</span></div>
                            <div class="result-item"><span class="label">è‚è„</span><span class="value">1200-1500g</span></div>
                            <div class="result-item"><span class="label">è„¾è„</span><span class="value">100-150g</span></div>
                            <div class="result-item"><span class="label">è‚¾è„</span><span class="value">120-150gÃ—2</span></div>
                            <div class="result-item"><span class="label">è‚ºè„</span><span class="value">300-500gÃ—2</span></div>
                            <div class="result-item"><span class="label">è„‘</span><span class="value">1300-1400g</span></div>
                        </div>
                    </div>
                `;
            },
            
            pmiView() {
                return `
                    <div class="form-card">
                        <h2>â° PMIï¼ˆæ­»äº¡æ—¶é—´ï¼‰ä¼°ç®—</h2>
                        <div class="form-group"><label>ç¯å¢ƒæ¸©åº¦ (Â°C)</label><input type="number" id="pmi-temp" value="20"></div>
                        <div class="form-group"><label>å°¸æ¸© (Â°C)</label><input type="number" id="pmi-body-temp" value="35"></div>
                        <div class="form-actions"><button onclick="document.getElementById('pmi-result').innerHTML = '<div class=calculator-result><p><strong>ä¼°ç®—æ­»äº¡æ—¶é—´:</strong> çº¦8-12å°æ—¶å‰</p></div>'">è®¡ç®—PMI</button></div>
                        <div id="pmi-result"></div>
                    </div>
                `;
            }
        };

        const toxicology = {
            currentSection: 'toxin-search',
            
            init() { this.render(); },
            setSection(section) { this.currentSection = section; this.render(); },
            
            render() {
                const container = document.getElementById('toxicology-content');
                switch(this.currentSection) {
                    case 'toxin-search':
                        container.innerHTML = this.toxinSearchView();
                        break;
                    case 'alcohol-calc':
                        container.innerHTML = this.alcoholCalcView();
                        break;
                    case 'standards':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ“š æŠ€æœ¯æ ‡å‡†</h2><div class="standard-card"><h3>ã€Šè¡€æ¶²é…’ç²¾å«é‡çš„æ£€éªŒæ–¹æ³•ã€‹GA/T 107-2013</h3></div></div>';
                        break;
                }
            },
            
            toxinSearchView() {
                const toxins = [
                    {name:'ä¹™é†‡',symptoms:'æ¬£å¿«ã€å—œç¡ã€æ˜è¿·',lethal:'5-8g/kg',specimen:'è¡€æ¶²ã€å°¿æ¶²',danger:'high'},
                    {name:'ç”²é†‡',symptoms:'å¤´ç—›ã€è§†åŠ›æ¨¡ç³Šâ†’å¤±æ˜',lethal:'30-100ml',specimen:'è¡€æ¶²',danger:'high'},
                    {name:'æ°°åŒ–ç‰©',symptoms:'å‘¼å¸å›°éš¾ã€æŠ½æ',lethal:'0.05-0.2g',specimen:'è¡€æ¶²',danger:'high'},
                    {name:'å—å•¡',symptoms:'å—œç¡ã€ç³å­”ç¼©å°',lethal:'0.2-0.4g',specimen:'è¡€æ¶²ã€å°¿æ¶²',danger:'high'},
                    {name:'ä¸€æ°§åŒ–ç¢³',symptoms:'å¤´ç—›ã€æ„è¯†éšœç¢',lethal:'50-60%HbCO',specimen:'è¡€æ¶²',danger:'high'},
                ];
                return `
                    <div class="form-card">
                        <h2>ğŸ” æ¯’ç‰©é€ŸæŸ¥æ‰‹å†Œ</h2>
                        <div class="search-bar">
                            <div class="search-input"><input type="text" placeholder="æœç´¢æ¯’ç‰©..." id="toxin-search"></div>
                        </div>
                        <table class="toxin-table">
                            <thead><tr><th>åç§°</th><th>ä¸­æ¯’ç—‡çŠ¶</th><th>è‡´æ­»é‡</th><th>æ£€æ</th><th>æ¯’æ€§</th></tr></thead>
                            <tbody>
                                ${toxins.map(t => `<tr><td><strong>${t.name}</strong></td><td>${t.symptoms}</td><td>${t.lethal}</td><td>${t.specimen}</td><td><span class="danger-level high">å‰§æ¯’</span></td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            alcoholCalcView() {
                return `
                    <div class="form-card">
                        <h2>ğŸº è¡€æ¶²é…’ç²¾æµ“åº¦ä¼°ç®—</h2>
                        <div class="form-group"><label>æ€§åˆ«</label><select id="alc-gender"><option>ç”·æ€§</option><option>å¥³æ€§</option></select></div>
                        <div class="form-group"><label>ä½“é‡ (kg)</label><input type="number" id="alc-weight" value="70"></div>
                        <div class="form-group"><label>é¥®é…’é‡ (ml)</label><input type="number" id="alc-amount" value="500"></div>
                        <div class="form-group"><label>é…’ç²¾åº¦æ•° (%)</label><input type="number" id="alc-percent" value="52"></div>
                        <div class="form-group"><label>é¥®é…’åæ—¶é—´ (å°æ—¶)</label><input type="number" id="alc-time" value="2"></div>
                        <div class="form-actions"><button onclick="document.getElementById('alc-result').innerHTML = '<div class=calculator-result><p><strong>è¡€æ¶²é…’ç²¾æµ“åº¦:</strong> 45.6 mg/100ml</p><p><strong>çŠ¶æ€:</strong> é¥®é…’é©¾é©¶ï¼ˆé…’é©¾ï¼‰</p></div>'">è®¡ç®—</button></div>
                        <div id="alc-result"></div>
                    </div>
                `;
            }
        };

        const psychiatry = {
            currentSection: 'self-care',
            
            init() { this.render(); },
            setSection(section) { this.currentSection = section; this.render(); },
            
            render() {
                const container = document.getElementById('psychiatry-content');
                switch(this.currentSection) {
                    case 'self-care':
                        container.innerHTML = this.selfCareView();
                        break;
                    case 'standards':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ“š æŠ€æœ¯æ ‡å‡†</h2><div class="standard-card"><h3>ã€Šç²¾ç¥éšœç¢è€…åˆ‘äº‹è´£ä»»èƒ½åŠ›è¯„å®šæŒ‡å—ã€‹SF/T 010-2021</h3></div></div>';
                        break;
                }
            },
            
            selfCareView() {
                return `
                    <div class="form-card">
                        <h2>ğŸ§  ç²¾ç¥éšœç¢ç”Ÿæ´»è‡ªç†èƒ½åŠ›è¯„ä¼°</h2>
                        <div class="form-group"><label>è¿›é£Ÿ</label><select><option>å®Œå…¨è‡ªç†</option><option>éƒ¨åˆ†éœ€å¸®åŠ©</option><option>å®Œå…¨ä¾èµ–</option></select></div>
                        <div class="form-group"><label>ç©¿è¡£</label><select><option>å®Œå…¨è‡ªç†</option><option>éƒ¨åˆ†éœ€å¸®åŠ©</option><option>å®Œå…¨ä¾èµ–</option></select></div>
                        <div class="form-group"><label>æ²æµ´</label><select><option>å®Œå…¨è‡ªç†</option><option>éƒ¨åˆ†éœ€å¸®åŠ©</option><option>å®Œå…¨ä¾èµ–</option></select></div>
                        <div class="form-group"><label>å¦‚å•</label><select><option>å®Œå…¨è‡ªç†</option><option>éƒ¨åˆ†éœ€å¸®åŠ©</option><option>å®Œå…¨ä¾èµ–</option></select></div>
                        <div class="form-actions"><button onclick="alert('è¯„ä¼°ç»“æœï¼šè½»åº¦éšœç¢ - åŸºæœ¬è‡ªç†')">è®¡ç®—è¯„ä¼°</button></div>
                    </div>
                `;
            }
        };

        const evidence = {
            currentSection: 'dna-basic',
            
            init() { this.render(); },
            setSection(section) { this.currentSection = section; this.render(); },
            
            render() {
                const container = document.getElementById('evidence-content');
                switch(this.currentSection) {
                    case 'dna-basic':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ§¬ DNAæ£€éªŒåŸºç¡€çŸ¥è¯†</h2><div class="standard-card"><h3>ä»€ä¹ˆæ˜¯DNAï¼Ÿ</h3><p>DNAï¼ˆè„±æ°§æ ¸ç³–æ ¸é…¸ï¼‰æ˜¯æºå¸¦é—ä¼ ä¿¡æ¯çš„åˆ†å­ï¼Œæ¯ä¸ªäººçš„DNAåºåˆ—éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚</p></div><div class="standard-card"><h3>æ³•åŒ»DNAæ£€æç±»å‹</h3><p>è¡€æ¶²ã€å£è…”æ‹­å­ã€æ¯›å‘ã€ç²¾æ¶²/é˜´é“åˆ†æ³Œç‰©ã€ç»„ç»‡/éª¨éª¼ã€æŒ‡ç”²/çš®å±‘</p></div></div>';
                        break;
                    case 'str':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ“Š STRåˆ†å‹</h2><div class="standard-card"><h3>å¸¸ç”¨STRåŸºå› åº§</h3><p>D3S1358ã€vWAã€FGAã€TH01ã€TPOXã€CSF1POã€D5S818ã€D13S317ã€D7S820ã€D8S1179</p></div></div>';
                        break;
                    case 'paternity':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ äº²å­é‰´å®š</h2><div class="standard-card"><h3>äº²å­é‰´å®šåŸç†</h3><p>æ ¹æ®å­Ÿå¾·å°”é—ä¼ è§„å¾‹ï¼Œå­ä»£çš„DNAä¸€åŠæ¥è‡ªçˆ¶äº²ï¼Œä¸€åŠæ¥è‡ªæ¯äº²ã€‚é€šè¿‡æ¯”å¯¹å¯ç–‘çˆ¶äº²ä¸å­©å­çš„STRåˆ†å‹ï¼Œè®¡ç®—äº²æƒæŒ‡æ•°ï¼ˆPIï¼‰å’Œç´¯è®¡äº²æƒæŒ‡æ•°ï¼ˆCPIï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨äº²ç¼˜å…³ç³»ã€‚</p></div><div class="standard-card"><h3>åˆ¤æ–­æ ‡å‡†</h3><p>CPI â‰¥ 10000: è‚¯å®šç”Ÿç‰©å­¦çˆ¶äº²å…³ç³»<br>CPI < 0.0001: æ’é™¤ç”Ÿç‰©å­¦çˆ¶äº²å…³ç³»</p></div></div>';
                        break;
                    case 'mixed':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ”¬ æ··åˆæ–‘è§£è¯»</h2><div class="standard-card"><h3>ä»€ä¹ˆæ˜¯æ··åˆæ–‘ï¼Ÿ</h3><p>æ··åˆæ–‘æ˜¯æŒ‡ç”±ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šä¸ªä½“çš„DNAæ··åˆå½¢æˆçš„æ£€æã€‚å¸¸è§äºæ€§çŠ¯ç½ªæ¡ˆä»¶ä¸­çš„ç²¾æ¶²ä¸é˜´é“åˆ†æ³Œç‰©æ··åˆã€‚</p></div></div>';
                        break;
                    case 'standards':
                        container.innerHTML = '<div class="form-card"><h2>ğŸ“š æŠ€æœ¯æ ‡å‡†</h2><div class="standard-card"><h3>ã€Šæ³•åŒ»DNAæ£€éªŒè§„èŒƒã€‹GA/T 1163-2014</h3></div></div>';
                        break;
                }
            }
        };

        const expert = {
            currentTab: 'experts',
            
            init() { this.render(); },
            setTab(tab) { this.currentTab = tab; this.render(); },
            
            render() {
                const container = document.getElementById('expert-content');
                const experts = [
                    {name:'å¼ ä¸»ä»»',title:'ä¸»ä»»æ³•åŒ»å¸ˆ',specialty:'æ³•åŒ»ç—…ç†',exp:'30å¹´',cases:5000,rating:4.9},
                    {name:'ææ•™æˆ',title:'æ•™æˆ',specialty:'æ³•åŒ»ä¸´åºŠ',exp:'25å¹´',cases:4200,rating:4.8},
                    {name:'ç‹åšå£«',title:'å‰¯ä¸»ä»»æ³•åŒ»å¸ˆ',specialty:'æ³•åŒ»æ¯’ç‰©',exp:'20å¹´',cases:3800,rating:4.9},
                ];
                
                switch(this.currentTab) {
                    case 'experts':
                        container.innerHTML = experts.map(e => `
                            <div class="expert-card">
                                <div class="expert-avatar">${e.name.charAt(0)}</div>
                                <div class="expert-info">
                                    <h3>${e.name}</h3>
                                    <p class="title">${e.title}</p>
                                    <p class="specialty">æ“…é•¿: ${e.specialty}</p>
                                    <div class="expert-stats"><span>ğŸ“… ${e.exp}</span><span>ğŸ“‹ ${e.cases}ä¾‹</span><span>â­ ${e.rating}</span></div>
                                    <div class="expert-actions"><button>ç«‹å³å’¨è¯¢</button><button class="secondary">é¢„çº¦</button></div>
                                </div>
                            </div>
                        `).join('');
                        break;
                    case 'qa':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>ğŸ’¬ åœ¨çº¿é—®ç­”</h2>
                                <div class="form-group"><textarea rows="4" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜..." id="qa-question"></textarea></div>
                                <div class="form-actions"><button onclick="alert('é—®é¢˜å·²æäº¤')">æäº¤é—®é¢˜</button></div>
                                <h3 style="margin-top:30px">å†å²é—®ç­”</h3>
                                <div class="qa-item">
                                    <div class="qa-question">Q: è‚‹éª¨éª¨æŠ˜å‡ æ ¹å¯ä»¥è¯„å®šä¼¤æ®‹ï¼Ÿ</div>
                                    <div class="qa-answer"><strong>å¼ ä¸»ä»»ï¼š</strong>æ ¹æ®ã€Šäººä½“æŸä¼¤ç¨‹åº¦é‰´å®šæ ‡å‡†ã€‹ï¼Œè‚‹éª¨éª¨æŠ˜2æ ¹ä»¥ä¸Šå¯è¯„å®šä¸ºè½»ä¼¤äºŒçº§ï¼Œ6æ ¹ä»¥ä¸Šå¯è¯„å®šä¸ºè½»ä¼¤ä¸€çº§ã€‚</div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'booking':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>ğŸ“… é¢„çº¦å’¨è¯¢</h2>
                                <div class="form-group"><label>é€‰æ‹©ä¸“å®¶</label><select><option>å¼ ä¸»ä»» - æ³•åŒ»ç—…ç†</option><option>ææ•™æˆ - æ³•åŒ»ä¸´åºŠ</option></select></div>
                                <div class="form-group"><label>é¢„çº¦æ—¥æœŸ</label><input type="date"></div>
                                <div class="form-group"><label>å’¨è¯¢æ–¹å¼</label><select><option>å›¾æ–‡å’¨è¯¢</option><option>è¯­éŸ³å’¨è¯¢</option><option>è§†é¢‘å’¨è¯¢</option></select></div>
                                <div class="form-actions"><button onclick="alert('é¢„çº¦æˆåŠŸï¼')">æäº¤é¢„çº¦</button></div>
                            </div>
                        `;
                        break;
                    case 'history':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>ğŸ“‹ å’¨è¯¢è®°å½•</h2>
                                <div class="qa-item">
                                    <div class="qa-question">å…³äºä¼¤æ®‹ç­‰çº§è¯„å®š</div>
                                    <div class="qa-meta"><span>å¼ ä¸»ä»»</span><span>2026-01-20</span><span style="color:#f39c12">å¾…å›å¤</span></div>
                                </div>
                                <div class="qa-item">
                                    <div class="qa-question">ç—…ç†åˆ‡ç‰‡åˆ†æå’¨è¯¢</div>
                                    <div class="qa-meta"><span>ææ•™æˆ</span><span>2026-01-15</span><span style="color:#28a745">å·²å®Œæˆ</span></div>
                                </div>
                            </div>
                        `;
                        break;
                }
            }
        };

        const profile = {
            currentTab: 'analyses',
            
            init() { this.render(); },
            setTab(tab) { this.currentTab = tab; this.render(); },
            
            render() {
                const container = document.getElementById('profile-content');
                switch(this.currentTab) {
                    case 'analyses':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>ğŸ“Š æˆ‘çš„åˆ†æ</h2>
                                <div class="qa-item"><div class="qa-question">è‚‹éª¨éª¨æŠ˜AIè¯Šæ–­</div><div class="qa-meta"><span>å·¦ä¾§ç¬¬4ã€5ã€6è‚‹éª¨éª¨æŠ˜</span><span>2026-01-20</span></div></div>
                                <div class="qa-item"><div class="qa-question">æŠ¤ç†ä¾èµ–è¯„ä¼°</div><div class="qa-meta"><span>äºŒçº§æŠ¤ç†ä¾èµ–</span><span>2026-01-18</span></div></div>
                                <div class="qa-item"><div class="qa-question">ç—…ç†åˆ‡ç‰‡åˆ†æ</div><div class="qa-meta"><span>æŸä¼¤ç—…ç†æ”¹å˜</span><span>2026-01-15</span></div></div>
                            </div>
                        `;
                        break;
                    case 'consults':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>ğŸ’¬ æˆ‘çš„å’¨è¯¢</h2>
                                <div class="qa-item"><div class="qa-question">å…³äºä¼¤æ®‹ç­‰çº§è¯„å®š</div><div class="qa-meta"><span>å¼ ä¸»ä»»</span><span>å¾…å›å¤</span></div></div>
                                <div class="qa-item"><div class="qa-question">ç—…ç†åˆ‡ç‰‡åˆ†æå’¨è¯¢</div><div class="qa-meta"><span>ææ•™æˆ</span><span>å·²å®Œæˆ</span></div></div>
                            </div>
                        `;
                        break;
                    case 'favorites':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>â­ æˆ‘çš„æ”¶è—</h2>
                                <div class="qa-item"><div class="qa-question">æ³•åŒ»ä¸´åºŠæŠ€æœ¯æ ‡å‡†</div></div>
                                <div class="qa-item"><div class="qa-question">å™¨å®˜é‡é‡å‚è€ƒ</div></div>
                                <div class="qa-item"><div class="qa-question">PMIè®¡ç®—å™¨</div></div>
                            </div>
                        `;
                        break;
                    case 'settings':
                        container.innerHTML = `
                            <div class="form-card">
                                <h2>âš™ï¸ è´¦å·è®¾ç½®</h2>
                                <div class="form-group"><label>ç”¨æˆ·å</label><input type="text" value="${auth.user?.name || ''}"></div>
                                <div class="form-group"><label>é‚®ç®±</label><input type="email" value="${auth.user?.email || ''}"></div>
                                <div class="form-actions"><button onclick="alert('ä¿å­˜æˆåŠŸ')">ä¿å­˜ä¿®æ”¹</button></div>
                            </div>
                        `;
                        break;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            router.render();
        });
    </script>
</body>
</html>
